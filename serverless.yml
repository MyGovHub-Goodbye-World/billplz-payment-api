service: aws-payment-api

frameworkVersion: '4'

provider:
  name: aws
  runtime: python3.10
  region: ${opt:region, "us-east-1"}
  stage: ${opt:stage, 'dev'}
  timeout: 29
  memorySize: 256 # Payment service can be leaner

  environment:
    CALLBACK_URL: ${env:CALLBACK_URL}
    REDIRECT_URL: ${env:REDIRECT_URL}

    MONGODB_MCP_URL: ${env:MONGODB_MCP_URL}
    DB_NAME: ${env:DB_NAME}
    COLLECTION_NAME: ${env:COLLECTION_NAME}

    JPJ_COLLECTION_ID: ${env:JPJ_COLLECTION_ID}
    TNB_COLLECTION_ID: ${env:TNB_COLLECTION_ID}
    JPJ_BILLPLZ_X_SIGNATURE_KEY: ${env:JPJ_BILLPLZ_X_SIGNATURE_KEY}
    TNB_BILLPLZ_X_SIGNATURE_KEY: ${env:TNB_BILLPLZ_X_SIGNATURE_KEY}

  iam:
    role:
      statements:
        - Effect: "Allow"
          Action:
            - "logs:CreateLogGroup"
            - "logs:CreateLogStream"
            - "logs:PutLogEvents"
          Resource: "arn:aws:logs:*:*:*"

functions:
  createBill:
    handler: payment_handler.create_bill
    events:
      - http:
          path: payment/create-bill
          method: post
          cors: true

  paymentWebhook:
    handler: payment_handler.handle_webhook
    events:
      - http:
          path: payment/webhook
          method: post

plugins:
  - serverless-dotenv-plugin
  - serverless-python-requirements